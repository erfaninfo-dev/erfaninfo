{% extends 'base.html' %}
{% block title %}Ø§Ù†ØªØ®Ø§Ø¨ Ú©ØªØ§Ø¨â€ŒÙ‡Ø§{% endblock %}

{% block content %}
<div class="container py-4 books-page">
  <style>
    /* ÙØ§ØµÙ„Ù‡ Ø¨ÛŒØ´ØªØ± Ø¨ÛŒÙ† Ú©Ø§Ø±Øªâ€ŒÙ‡Ø§ Ùˆ Ú¯Ø±Ø¯ØªØ± Ø´Ø¯Ù† Ú¯ÙˆØ´Ù‡â€ŒÙ‡Ø§ */
    .books-grid > [class*='col-'] .card { border-radius: 18px; overflow: hidden; }
    .books-grid { row-gap: .1rem; }
    .book-title { font-weight: 800; font-size: 1.05rem; color:#111827; text-align:left; direction:ltr; margin-bottom:.4rem; }
    .meta-row { display:flex; align-items:center; justify-content:flex-start; gap:.5rem; margin-bottom:.4rem; direction: rtl; }
    .badge-pill { display:inline-flex; align-items:center; gap:.4rem; padding:.20rem .66rem; border-radius:14px; background:#f3f4f6; color:#374151; font-size:.84rem; }
    .badge-units { background:#eef2ff; color:#4338ca; }
    /* Ø¯Ú©Ù…Ù‡ Ø§Ø³ØªØ§Ø±Øª Ø¬Ø°Ø§Ø¨â€ŒØªØ± Ùˆ Ø¬Ù…Ø¹â€ŒÙˆØ¬ÙˆØ± */
    .book-card-btn {
      display: inline-flex !important;
      align-items: center;
      justify-content: center;
      gap: 8px;
      width: fit-content !important; /* ÙÙ‚Ø· Ø¨Ù‡ Ø§Ù†Ø¯Ø§Ø²Ù‡ Ù…ØªÙ† + Ù¾Ø¯ÛŒÙ†Ú¯ */
      min-width: 200px;              /* Ø¹Ø±Ø¶ Ø­Ø¯Ø§Ù‚Ù„ÛŒ Ø¨ÛŒØ´ØªØ± */
      padding: 10px 18px !important; /* Ú©Ù…ÛŒ Ø¨Ø²Ø±Ú¯â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø¬Ø°Ø§Ø¨ÛŒØª */
      border-radius: 14px !important;
      background-image: linear-gradient(135deg, #4f46e5, #06b6d4) !important;
      border: 0 !important;
      color: #fff !important;
      font-weight: 800 !important;
      box-shadow: 0 10px 22px rgba(79,70,229,0.28) !important;
      transition: transform .15s ease, filter .15s ease, box-shadow .15s ease !important;
      text-decoration: none !important; /* Ø¨Ø¯ÙˆÙ† underline */
      white-space: nowrap; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² Ø´Ú©Ø³ØªÙ† Ù…ØªÙ† */
      margin-inline: auto; /* ÙˆØ³Ø· Ú†ÛŒÙ† Ø§ÙÙ‚ÛŒ */
      background-color: transparent !important; /* Ø¬Ù„ÙˆÚ¯ÛŒØ±ÛŒ Ø§Ø² ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ Ù¾ÛŒØ´ÙØ±Ø¶ Ø¨ÙˆØªâ€ŒØ§Ø³ØªØ±Ù¾ */
      -webkit-tap-highlight-color: transparent; /* Ø­Ø°Ù Ù„Ø§ÛŒÙ‡ Ø±ÙˆØ´Ù† Ù…Ø±ÙˆØ±Ú¯Ø±Ù‡Ø§ÛŒ Ù…ÙˆØ¨Ø§ÛŒÙ„ */
      user-select: none; -webkit-user-select: none; -webkit-touch-callout: none;
    }
    .book-card-btn:hover { filter: brightness(1.06); transform: translateY(-1px); box-shadow: 0 14px 28px rgba(79,70,229,0.32) !important; text-decoration: none !important; }
    .book-card-btn:active { filter: brightness(0.97) !important; box-shadow: 0 6px 16px rgba(79,70,229,0.26) !important; }
    .book-card-btn:focus { filter: brightness(1); outline: none !important; }
    /* Override Ø­Ø§Ù„Ø§Øª ÙØ¹Ø§Ù„ Ø¨ÙˆØªâ€ŒØ§Ø³ØªØ±Ù¾ ØªØ§ Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† Ø­ÙØ¸ Ø´ÙˆØ¯ */
    .book-card-btn:active, .book-card-btn:focus, .book-card-btn:hover {
      background-image: linear-gradient(135deg, #4f46e5, #06b6d4) !important;
      background-color: transparent !important;
      color: #fff !important;
    }
    .book-card-btn .emoji { font-size: 1.1em; }
    /* Ø­Ø§Ù„Øª Ú©Ù…ÛŒ Ø¨ÛŒâ€ŒØ±ÙˆØ­â€ŒØªØ± Ø¨Ø±Ø§ÛŒ Ø¯Ú©Ù…Ù‡â€ŒÙ‡Ø§ÛŒ "Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ..." Ø¨Ø§ Ø­ÙØ¸ Ø§Ù†Ø¯Ø§Ø²Ù‡ */
    .book-card-btn.soon-btn {
      /* Ù†Ø³Ø®Ù‡ Ø¨ÛŒâ€ŒØ±ÙˆØ­â€ŒØªØ± Ùˆ Ú©Ù…ÛŒ Ú¯Ø±Ù…â€ŒØªØ± Ø§Ø² Ú¯Ø±Ø§Ø¯ÛŒØ§Ù† Ø§ØµÙ„ÛŒ (Ø§Ù„Ù‡Ø§Ù… Ø§Ø² Ø§ÛŒÙ†Ø¯ÛŒÚ¯Ùˆ/Ø³ÛŒØ§Ù†) */
      background-image: linear-gradient(135deg, #a5b4fc, #7dd3fc) !important; /* indigo-300 â†’ sky-300 */
      color: #ffffff !important; /* Ú©Ù…ÛŒ ÙˆØ§Ø¶Ø­â€ŒØªØ± */
      text-shadow: 0 1px 1px rgba(0,0,0,0.15);
      box-shadow: 0 6px 14px rgba(108,117,125,0.16) !important;
      filter: saturate(0.82) brightness(0.97);
      border: 1px solid rgba(165, 180, 252, 0.45) !important; /* Ù„Ø¨Ù‡ Ú©Ù…ÛŒ Ø¨Ù†ÙØ´ Ø±ÙˆØ´Ù† */
      cursor: not-allowed;
    }
    .book-card-btn.soon-btn:hover { filter: saturate(0.78) brightness(0.96); box-shadow: 0 6px 14px rgba(108,117,125,0.15) !important; }
    /* Ú©ÙˆÚ†Ú©â€ŒØªØ± Ú©Ø±Ø¯Ù† Ù…ØªÙ† Ù„ÛŒØ¨Ù„â€ŒÙ‡Ø§ Ùˆ Ø³Ù„Ú©Øªâ€ŒÙ‡Ø§ Ø¯Ø± Ø¯Ø³Ú©ØªØ§Ù¾ */
    .book-controls .form-label { font-size: .82rem; margin-bottom: .25rem; }
    .book-controls .form-select { font-size: .85rem; }
    @media (max-width: 576px) {
      .books-page { padding-top: 8px !important; }
      .tests-header { margin-top: 0 !important; }
      .book-controls { flex-wrap: wrap; gap: 6px !important; }
      .book-controls .flex-fill { flex: 1 1 32%; min-width: 0; }
      .book-controls .form-label { font-size: .72rem; margin-bottom: .2rem; }
      .book-controls .form-select { font-size: .75rem; padding: .25rem .5rem; height: calc(1.6em + .5rem + 2px); }
      .book-card-btn { font-size: .9rem; padding: .45rem .75rem; }
      /* Ø³Ø·Ø­ (badge) Ø¯Ø± Ù…ÙˆØ¨Ø§ÛŒÙ„: Ù…ØªÙ† Ú©ÙˆÚ†Ú©ØªØ± Ùˆ Ú¯Ø±Ø¯ÛŒ Ø¨ÛŒØ´ØªØ± */
      .meta-row { gap:.28rem; }
      .badge-pill { padding:.10rem .36rem; border-radius:14px; font-size:.56rem; }
    }
  </style>
  <div class="tests-header" style="margin-bottom: 1rem;">
    <h1>ØªÙ…Ø±ÛŒÙ† ÙˆØ§Ú˜Ú¯Ø§Ù† Ú©ØªØ§Ø¨â€ŒÙ‡Ø§</h1>
    <p class="tests-desc" style="margin-top:.25rem;color:#6b7280;">Ú©ØªØ§Ø¨ Ù…ÙˆØ±Ø¯ Ù†Ø¸Ø± Ø®ÙˆØ¯ Ø±Ø§ Ø§Ù†ØªØ®Ø§Ø¨ Ú©Ù†ÛŒØ¯ Ùˆ ØªØ³Øª Ù„ØºØ§Øª Ø±Ø§ Ø´Ø±ÙˆØ¹ Ú©Ù†ÛŒØ¯.</p>
  </div>

  <div class="row g-4 books-grid">
    {% for b in books %}
    <div class="col-12 col-sm-6 col-lg-4">
      <div class="card h-100 shadow-sm">
        <div class="book-cover" style="background:#ffffff; height:220px; display:flex; align-items:center; justify-content:center; border-radius:16px; overflow:hidden; margin:8px; box-shadow:0 2px 10px rgba(0,0,0,0.06);">
          <img src="{{ b.cover_url }}" alt="{{ b.title }}" style="max-width:100%; max-height:100%; object-fit: contain; display:block;">
        </div>
         <div class="card-body d-flex flex-column">
           <h2 class="book-title">{{ b.title }}</h2>
            <div class="meta-row">
              <span class="badge-pill">Ø³Ø·Ø­: <span dir="ltr">{{ b.level }}</span></span>
            </div>
           <p class="small flex-grow-1" style="line-height:1.7; text-align:right;">{{ b.description }}</p>
           {% set has_units = b.units and (b.units|length) > 0 %}
           {% if has_units %}
           <div class="mt-2 d-flex gap-2 align-items-end book-controls">
            <div class="flex-fill">
              <label class="form-label mb-1">Ø§Ù†ØªØ®Ø§Ø¨ Ø¯Ø±Ø³</label>
              <select class="form-select form-select-sm" id="unit-select-{{ b.id }}">
                <option value="">Ù‡Ù…Ù‡</option>
                {% for u in b.units %}
                <option value="{{ u }}">Ø¯Ø±Ø³ {{ u }}</option>
                {% endfor %}
              </select>
            </div>
            <div class="flex-fill">
              <label class="form-label mb-1">Ù†ÙˆØ¹ Ø³ÙˆØ§Ù„</label>
              <select class="form-select form-select-sm" id="type-select-{{ b.id }}" onchange="onTypeChange({{ b.id }})">
                <option value="">Ù‡Ù…Ù‡</option>
                <option value="matching">ÙˆØµÙ„ Ú©Ø±Ø¯Ù†</option>
                <option value="mcq">Ú†Ù‡Ø§Ø± Ú¯Ø²ÛŒÙ†Ù‡â€ŒØ§ÛŒ</option>
                <option value="gapfill">Ø¬Ø§ÛŒ Ø®Ø§Ù„ÛŒ</option>
              </select>
            </div>
            <div class="flex-fill">
              <label class="form-label mb-1">ØªØ¹Ø¯Ø§Ø¯ Ø³ÙˆØ§Ù„ Ù‡Ø± Ø¯Ø±Ø³</label>
              <select class="form-select form-select-sm" id="count-select-{{ b.id }}">
                <option value="all">Ù‡Ù…Ù‡</option>
                <option value="20" selected>20</option>
                <option value="15">15</option>
                <option value="10">10</option>
              </select>
            </div>
          </div>
           {% endif %}
           <div class="mt-3 d-grid">
             {% if has_units %}
               <a href="#" class="btn book-card-btn" onclick="startBookQuiz({{ b.id }}); return false;">
                 <span>Ø´Ø±ÙˆØ¹ ØªØ³Øª Ù„ØºØ§Øª</span>
                 <span class="emoji">ğŸš€</span>
               </a>
             {% else %}
                <button type="button" class="book-card-btn soon-btn" disabled>Ø¨Ù‡ Ø²ÙˆØ¯ÛŒ... <span class="emoji">â³</span></button>
             {% endif %}
           </div>
        </div>
      </div>
    </div>
    {% endfor %}
  </div>
</div>

<script>
function startBookQuiz(bookId) {
  const sel = document.getElementById('unit-select-' + bookId);
  const unit = sel ? sel.value : '';
  const typeSel = document.getElementById('type-select-' + bookId);
  const qtype = typeSel ? typeSel.value : '';
  const countSel = document.getElementById('count-select-' + bookId);
  const perUnit = countSel ? countSel.value : '';
  const params = new URLSearchParams();
  if (unit) params.append('unit', unit);
  if (qtype) params.append('qtype', qtype);
  if (perUnit && perUnit !== '') params.append('per_unit', perUnit);
  var base = '/books_vocab/' + bookId + '/quiz';
  var url = params.toString() ? (base + '?' + params.toString()) : base;
  window.location.href = url;
}

function setOptions(selectEl, options, defaultValue) {
  if (!selectEl) return;
  selectEl.innerHTML = options.map(function(o){ return '<option value="' + o.v + '">' + o.t + '</option>'; }).join('');
  // Ø·Ø¨Ù‚ Ù†ÛŒØ§Ø² Ø¬Ø¯ÛŒØ¯ØŒ Ù‡Ù…ÛŒØ´Ù‡ Ù…Ù‚Ø¯Ø§Ø± Ù¾ÛŒØ´â€ŒÙØ±Ø¶ ØªÙ†Ø¸ÛŒÙ… Ø´ÙˆØ¯
  selectEl.value = defaultValue;
}

function onTypeChange(bookId) {
  const typeSel = document.getElementById('type-select-' + bookId);
  const countSel = document.getElementById('count-select-' + bookId);
  if (!typeSel || !countSel) return;
  const isAll = (typeSel.value === '');
  if (isAll) {
    // Ù„ÛŒØ³Øª Ø¨Ø§ "Ù‡Ù…Ù‡" Ø¯Ø± Ø§Ø¨ØªØ¯Ø§Ø› Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ 20
    setOptions(countSel, [
      { v: 'all', t: 'Ù‡Ù…Ù‡' },
      { v: '20', t: '20' },
      { v: '15', t: '15' },
      { v: '10', t: '10' }
    ], '20');
  } else {
    // Ù„ÛŒØ³Øª Ø¨Ø§ "Ù‡Ù…Ù‡" Ø¯Ø± Ø§Ø¨ØªØ¯Ø§Ø› Ù¾ÛŒØ´â€ŒÙØ±Ø¶ Ø§Ù†ØªØ®Ø§Ø¨ÛŒ 15
    setOptions(countSel, [
      { v: 'all', t: 'Ù‡Ù…Ù‡' },
      { v: '15', t: '15' },
      { v: '10', t: '10' },
      { v: '5',  t: '5'  }
    ], '15');
  }
}
</script>
{% endblock %}


