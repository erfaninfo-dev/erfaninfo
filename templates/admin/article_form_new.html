{% extends 'admin/article_base.html' %}

{% block title %}
    {% if article %}ÙˆÛŒØ±Ø§ÛŒØ´ Ù…Ù‚Ø§Ù„Ù‡{% else %}Ù…Ù‚Ø§Ù„Ù‡ Ø¬Ø¯ÛŒØ¯{% endif %} - Ù¾Ù†Ù„ Ø§Ø¯Ù…ÛŒÙ†
{% endblock %}

<style>
    /* Ø§Ø³ØªØ§ÛŒÙ„ Ù¾ÛŒØ§Ù…â€ŒÙ‡Ø§ÛŒ Ù…ÙˆÙÙ‚ÛŒØª Ùˆ Ø®Ø·Ø§ */
    .alert {
        border-radius: 8px;
        padding: 15px 20px;
        margin: 10px 0;
        font-weight: 500;
        box-shadow: 0 4px 12px rgba(0,0,0,0.15);
        animation: slideIn 0.3s ease-out;
    }
    
    .alert-success {
        background: linear-gradient(135deg, #28a745, #20c997);
        color: white;
        border: none;
    }
    
    .alert-danger {
        background: linear-gradient(135deg, #dc3545, #e74c3c);
        color: white;
        border: none;
    }
    
    @keyframes slideIn {
        from {
            transform: translateX(100%);
            opacity: 0;
        }
        to {
            transform: translateX(0);
            opacity: 1;
        }
    }
</style>

{% block admin_content %}
<div class="article-form-container">


    {% if error %}
    <div class="alert alert-danger" role="alert">
        <strong>Ø®Ø·Ø§!</strong> {{ error }}
    </div>
    {% endif %}

    <form method="POST" id="articleForm">
        <!-- Ø¯Ú©Ù…Ù‡ Ø¨Ø§Ø²Ú¯Ø´Øª -->
        <div class="back-button-container">
            <a href="{{ url_for('admin_articles') }}" class="back-btn">
                <i class="fas fa-arrow-left"></i> Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ù„ÛŒØ³Øª Ù…Ù‚Ø§Ù„Ø§Øª
            </a>
        </div>
        
        <!-- Ú©Ø§Ø±Øª Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ù…Ù‚Ø§Ù„Ù‡ -->
        <div class="article-main-card">
            <div class="card-header">
                <h3>ğŸ“ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ù…Ù‚Ø§Ù„Ù‡</h3>
            </div>
            <div class="card-content">
                <!-- Ø¹Ù†ÙˆØ§Ù†â€ŒÙ‡Ø§ -->
                <div class="form-section">
                    <h4>ğŸ·ï¸ Ø¹Ù†ÙˆØ§Ù†â€ŒÙ‡Ø§</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="title_fa">Ø¹Ù†ÙˆØ§Ù† ÙØ§Ø±Ø³ÛŒ *</label>
                            <input type="text" class="form-control" id="title_fa" name="title_fa" 
                                   value="{{ article.title_fa if article else '' }}" required>
                        </div>
                        
                        <div class="form-group">
                            <label for="title_ku">Ø¹Ù†ÙˆØ§Ù† Ú©ÙˆØ±Ø¯ÛŒ</label>
                            <input type="text" class="form-control" id="title_ku" name="title_ku" 
                                   value="{{ article.title_ku if article else '' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="title_en">Ø¹Ù†ÙˆØ§Ù† Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</label>
                            <input type="text" class="form-control" id="title_en" name="title_en" 
                                   value="{{ article.title_en if article else '' }}">
                        </div>
                    </div>
                </div>

                <!-- Ø®Ù„Ø§ØµÙ‡ -->
                <div class="form-section">
                    <h4>ğŸ“„ Ø®Ù„Ø§ØµÙ‡</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="excerpt_fa">Ø®Ù„Ø§ØµÙ‡ ÙØ§Ø±Ø³ÛŒ</label>
                            <textarea class="form-control" id="excerpt_fa" name="excerpt_fa" rows="3">{{ article.excerpt_fa if article else '' }}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="excerpt_ku">Ø®Ù„Ø§ØµÙ‡ Ú©ÙˆØ±Ø¯ÛŒ</label>
                            <textarea class="form-control" id="excerpt_ku" name="excerpt_ku" rows="3">{{ article.excerpt_ku if article else '' }}</textarea>
                        </div>
                        
                        <div class="form-group">
                            <label for="excerpt_en">Ø®Ù„Ø§ØµÙ‡ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ</label>
                            <textarea class="form-control" id="excerpt_en" name="excerpt_en" rows="3">{{ article.excerpt_en if article else '' }}</textarea>
                        </div>
                    </div>
                </div>

                <!-- ØªÚ¯â€ŒÙ‡Ø§ -->
                <div class="form-section">
                    <h4>ğŸ·ï¸ ØªÚ¯â€ŒÙ‡Ø§</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="tags_fa">ØªÚ¯â€ŒÙ‡Ø§ÛŒ ÙØ§Ø±Ø³ÛŒ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)</label>
                            <input type="text" class="form-control" id="tags_fa" name="tags_fa" 
                                   value="{{ article.tags_fa if article else '' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="tags_ku">ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ú©ÙˆØ±Ø¯ÛŒ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)</label>
                            <input type="text" class="form-control" id="tags_ku" name="tags_ku" 
                                   value="{{ article.tags_ku if article else '' }}">
                        </div>
                        
                        <div class="form-group">
                            <label for="tags_en">ØªÚ¯â€ŒÙ‡Ø§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ (Ø¬Ø¯Ø§ Ø´Ø¯Ù‡ Ø¨Ø§ Ú©Ø§Ù…Ø§)</label>
                            <input type="text" class="form-control" id="tags_en" name="tags_en" 
                                   value="{{ article.tags_en if article else '' }}">
                        </div>
                    </div>
                </div>

                <!-- ØªÙ†Ø¸ÛŒÙ…Ø§Øª -->
                <div class="form-section">
                    <h4>âš™ï¸ ØªÙ†Ø¸ÛŒÙ…Ø§Øª</h4>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="category">Ø¯Ø³ØªÙ‡â€ŒØ¨Ù†Ø¯ÛŒ</label>
                            <select class="form-control" id="category" name="category">
                                <option value="Ú¯Ø±Ø§Ù…Ø±" {% if article and article.category == 'Ú¯Ø±Ø§Ù…Ø±' %}selected{% endif %}>Ú¯Ø±Ø§Ù…Ø±</option>
                                <option value="ÙˆØ§Ú˜Ú¯Ø§Ù†" {% if article and article.category == 'ÙˆØ§Ú˜Ú¯Ø§Ù†' %}selected{% endif %}>ÙˆØ§Ú˜Ú¯Ø§Ù†</option>
                                <option value="Ù…Ú©Ø§Ù„Ù…Ù‡" {% if article and article.category == 'Ù…Ú©Ø§Ù„Ù…Ù‡' %}selected{% endif %}>Ù…Ú©Ø§Ù„Ù…Ù‡</option>
                                <option value="Ù†ÙˆØ´ØªÙ†" {% if article and article.category == 'Ù†ÙˆØ´ØªÙ†' %}selected{% endif %}>Ù†ÙˆØ´ØªÙ†</option>
                            </select>
                        </div>
                        
                        <div class="form-group">
                            <label for="reading_time">Ø²Ù…Ø§Ù† Ù…Ø·Ø§Ù„Ø¹Ù‡ (Ø¯Ù‚ÛŒÙ‚Ù‡)</label>
                            <input type="number" class="form-control" id="reading_time" name="reading_time" 
                                   value="{{ article.reading_time if article else 10 }}" min="1" max="120">
                        </div>
                        
                        <div class="form-group">
                            <div class="custom-control custom-checkbox">
                                <input type="checkbox" class="custom-control-input" id="is_published" name="is_published"
                                       {% if article and article.is_published %}checked{% endif %}>
                                <label class="custom-control-label" for="is_published">Ù…Ù†ØªØ´Ø± Ø´ÙˆØ¯</label>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Ú©Ø§Ø±Øª ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ -->
        <div class="article-settings-card">
            <div class="card-header">
                <h3>ğŸ”§ ØªÙ†Ø¸ÛŒÙ…Ø§Øª Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§</h3>
            </div>
            <div class="card-content">
                <div class="form-group">
                    <label>Ø¬Ù‡Øª Ù…ØªÙ†:</label>
                    <select class="form-control text-direction">
                        <option value="">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</option>
                        <option value="rtl">Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾ (RTL)</option>
                        <option value="ltr">Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª (LTR)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ù…ÙˆÙ‚Ø¹ÛŒØª:</label>
                    <select class="form-control text-position">
                        <option value="">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</option>
                        <option value="left">Ú†Ù¾</option>
                        <option value="right">Ø±Ø§Ø³Øª</option>
                        <option value="center">ÙˆØ³Ø·</option>
                    </select>
                </div>
                
                <button type="button" class="btn btn-success btn-block" onclick="addBlock()">
                    <i class="fas fa-plus"></i> Ø§ÙØ²ÙˆØ¯Ù† Ø¨Ù„Ø§Ú©
                </button>
            </div>
        </div>

        <!-- Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙˆØ§ -->
        <div class="content-blocks-section">
            <div class="card-header">
                <h3>ğŸ“š Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…Ø­ØªÙˆØ§</h3>
            </div>
            <div class="card-content">
                <div id="blocksContainer">
                    <!-- Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ Ø§ÛŒÙ†Ø¬Ø§ Ø§Ø¶Ø§ÙÙ‡ Ù…ÛŒâ€ŒØ´ÙˆÙ†Ø¯ -->
                </div>
                
                <div class="text-center mt-4">
                    <button type="submit" class="btn btn-primary btn-lg">
                        <i class="fas fa-save"></i> 
                        {% if article %}Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ù„Ù‡{% else %}Ø§ÛŒØ¬Ø§Ø¯ Ù…Ù‚Ø§Ù„Ù‡{% endif %}
                    </button>
                </div>
            </div>
        </div>
    </form>
</div>

<!-- Template Ø¨Ø±Ø§ÛŒ Ø¨Ù„Ø§Ú© -->
<template id="blockTemplate">
    <div class="block-item" data-block-index="" data-block-id="">
        <div class="block-header">
            <span class="block-type-badge"></span>
            <div class="block-actions">
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveBlock(this, 'up')">
                    <i class="fas fa-arrow-up"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-secondary" onclick="moveBlock(this, 'down')">
                    <i class="fas fa-arrow-down"></i>
                </button>
                <button type="button" class="btn btn-sm btn-outline-danger" onclick="removeBlock(this)">
                    <i class="fas fa-trash"></i>
                </button>
            </div>
        </div>
        <div class="block-content">
                            <div class="form-row">
                    <div class="form-group">
                        <label>Ù†ÙˆØ¹ Ø¨Ù„Ø§Ú©:</label>
                        <select class="form-control block-type" name="block_type[]" required onchange="changeBlockType(this)">
                            <option value="paragraph">Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù</option>
                            <option value="subtitle">ØªÛŒØªØ± ÙØ±Ø¹ÛŒ</option>
                            <option value="example">Ù…Ø«Ø§Ù„</option>
                            <option value="note">Ù†Ú©ØªÙ‡</option>
                            <option value="code">Ú©Ø¯</option>
                        </select>
                    </div>
                
                <div class="form-group">
                    <label>ØªØ±ØªÛŒØ¨:</label>
                    <input type="number" class="form-control" name="order_num[]" min="1" required>
                </div>
                
                <div class="form-group">
                    <label>Ø¬Ù‡Øª Ù…ØªÙ†:</label>
                    <select class="form-control text-direction">
                        <option value="">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</option>
                        <option value="rtl">Ø±Ø§Ø³Øª Ø¨Ù‡ Ú†Ù¾ (RTL)</option>
                        <option value="ltr">Ú†Ù¾ Ø¨Ù‡ Ø±Ø§Ø³Øª (LTR)</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>Ù…ÙˆÙ‚Ø¹ÛŒØª:</label>
                    <select class="form-control text-position">
                        <option value="">Ù¾ÛŒØ´â€ŒÙØ±Ø¶</option>
                        <option value="left">Ú†Ù¾</option>
                        <option value="right">Ø±Ø§Ø³Øª</option>
                        <option value="center">ÙˆØ³Ø·</option>
                    </select>
                </div>
            </div>
            
            <div class="form-row">
                <div class="form-group">
                    <label>Ù…Ø­ØªÙˆØ§ÛŒ ÙØ§Ø±Ø³ÛŒ *:</label>
                    <textarea class="form-control" name="content_fa[]" rows="4" required></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ù…Ø­ØªÙˆØ§ÛŒ Ú©ÙˆØ±Ø¯ÛŒ:</label>
                    <textarea class="form-control" name="content_ku[]" rows="4"></textarea>
                </div>
                
                <div class="form-group">
                    <label>Ù…Ø­ØªÙˆØ§ÛŒ Ø§Ù†Ú¯Ù„ÛŒØ³ÛŒ:</label>
                    <textarea class="form-control" name="content_en[]" rows="4"></textarea>
                </div>
            </div>
            
            <input type="hidden" class="block-metadata" name="block_metadata[]" value="{}">
            
            <!-- Ø¯Ú©Ù…Ù‡ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù„Ø§Ú© -->
            <div class="block-save-section">
                <button type="button" class="btn btn-success btn-sm" onclick="saveBlock(this)">
                    <i class="fas fa-save"></i> Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù„Ø§Ú©
                </button>
                <span class="save-status"></span>
            </div>
        </div>
    </div>
</template>

<script>
let blockCounter = 0;

function addBlock() {
    const template = document.getElementById('blockTemplate');
    const container = document.getElementById('blocksContainer');
    const clone = template.content.cloneNode(true);
    
    // ØªÙ†Ø¸ÛŒÙ… Ø´Ù…Ø§Ø±Ù‡ Ø¨Ù„Ø§Ú©
    clone.querySelector('.block-item').setAttribute('data-block-index', blockCounter);
    clone.querySelector('input[name="order_num[]"]').value = blockCounter + 1;
    
    // ØªÙ†Ø¸ÛŒÙ… block_id Ø¨Ø±Ø§ÛŒ Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ø¬Ø¯ÛŒØ¯ (null)
    clone.querySelector('.block-item').setAttribute('data-block-id', '');
    
    // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ø¨Ù„Ø§Ú©
    const blockType = clone.querySelector('.block-type');
    const badge = clone.querySelector('.block-type-badge');
    const blockHeader = clone.querySelector('.block-header');
    
    // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ø´Ø¯Ù‡
    const initialType = blockType.value;
    badge.textContent = getBlockTypeName(initialType);
    
    // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ø§ÙˆÙ„ÛŒÙ‡ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
    switch(initialType) {
        case 'paragraph':
            badge.className = 'block-type-badge badge badge-primary';
            blockHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            break;
        case 'subtitle':
            badge.className = 'block-type-badge badge badge-secondary';
            blockHeader.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
            break;
        case 'example':
            badge.className = 'block-type-badge badge badge-success';
            blockHeader.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
            break;
        case 'note':
            badge.className = 'block-type-badge badge badge-warning';
            blockHeader.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            break;
        case 'code':
            badge.className = 'block-type-badge badge badge-info';
            blockHeader.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            break;
    }
    
    container.appendChild(clone);
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø¹Ø¯ Ø§Ø² append
    const addedBlock = container.lastElementChild;
    const addedBlockType = addedBlock.querySelector('.block-type');
    addedBlockType.addEventListener('change', function() {
        changeBlockType(this);
    });
    
    blockCounter++;
    updateBlockMetadata();
}

function removeBlock(button) {
    if (confirm('Ø¢ÛŒØ§ Ø§Ø² Ø­Ø°Ù Ø§ÛŒÙ† Ø¨Ù„Ø§Ú© Ø§Ø·Ù…ÛŒÙ†Ø§Ù† Ø¯Ø§Ø±ÛŒØ¯ØŸ')) {
        button.closest('.block-item').remove();
        updateBlockMetadata();
    }
}

function moveBlock(button, direction) {
    const block = button.closest('.block-item');
    const container = document.getElementById('blocksContainer');
    
    if (direction === 'up' && block.previousElementSibling) {
        container.insertBefore(block, block.previousElementSibling);
    } else if (direction === 'down' && block.nextElementSibling) {
        container.insertBefore(block.nextElementSibling, block);
    }
    
    updateBlockMetadata();
}

function getBlockTypeName(type) {
    const names = {
        'paragraph': 'Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù',
        'subtitle': 'ØªÛŒØªØ± ÙØ±Ø¹ÛŒ',
        'example': 'Ù…Ø«Ø§Ù„',
        'note': 'Ù†Ú©ØªÙ‡',
        'code': 'Ú©Ø¯'
    };
    return names[type] || type;
}

function changeBlockType(selectElement) {
    const blockItem = selectElement.closest('.block-item');
    const badge = blockItem.querySelector('.block-type-badge');
    const newType = selectElement.value;
    
    // ØªØºÛŒÛŒØ± Ù…ØªÙ† badge
    badge.textContent = getBlockTypeName(newType);
    
    // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ badge Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
    badge.className = 'block-type-badge badge';
    
    switch(newType) {
        case 'paragraph':
            badge.classList.add('badge-primary');
            break;
        case 'subtitle':
            badge.classList.add('badge-secondary');
            break;
        case 'example':
            badge.classList.add('badge-success');
            break;
        case 'note':
            badge.classList.add('badge-warning');
            break;
        case 'code':
            badge.classList.add('badge-info');
            break;
    }
    
    // ØªØºÛŒÛŒØ± Ø±Ù†Ú¯ header Ø¨Ù„Ø§Ú© Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
    const blockHeader = blockItem.querySelector('.block-header');
    blockHeader.className = 'block-header';
    
    switch(newType) {
        case 'paragraph':
            blockHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            break;
        case 'subtitle':
            blockHeader.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
            break;
        case 'example':
            blockHeader.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
            break;
        case 'note':
            blockHeader.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            break;
        case 'code':
            blockHeader.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            break;
    }
    
    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ metadata
    updateBlockMetadata();
}

function updateBlockMetadata() {
    const blocks = document.querySelectorAll('.block-item');
    blocks.forEach((block, index) => {
        const direction = block.querySelector('.text-direction').value;
        const position = block.querySelector('.text-position').value;
        const metadata = {};
        
        if (direction) metadata.direction = direction;
        if (position) metadata.position = position;
        
        const metadataInput = block.querySelector('.block-metadata');
        if (metadataInput) {
            metadataInput.value = JSON.stringify(metadata);
        }
        
        const orderInput = block.querySelector('input[name="order_num[]"]');
        if (orderInput) {
            orderInput.value = index + 1;
        }
        
        // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ø¨Ù„Ø§Ú© Ø§Ø² Ú©Ù¾Ø³Ù„ Ø§Ú¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        const typeSelect = block.querySelector('.block-type');
        const badge = block.querySelector('.block-type-badge');
        
        if (!typeSelect.value || typeSelect.value === '') {
            const badgeText = badge.textContent.trim();
            let blockType = 'paragraph'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
            
            // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ø§Ø² Ù…ØªÙ† Ú©Ù¾Ø³Ù„
            if (badgeText.includes('Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù')) blockType = 'paragraph';
            else if (badgeText.includes('ØªÛŒØªØ± ÙØ±Ø¹ÛŒ')) blockType = 'subtitle';
            else if (badgeText.includes('Ù…Ø«Ø§Ù„')) blockType = 'example';
            else if (badgeText.includes('Ù†Ú©ØªÙ‡')) blockType = 'note';
            else if (badgeText.includes('Ú©Ø¯')) blockType = 'code';
            
            typeSelect.value = blockType;
            console.log(`Block ${index}: Auto-set type to '${blockType}' from badge '${badgeText}'`);
        }
    });
}

// Ø¨Ø§Ø±Ú¯Ø°Ø§Ø±ÛŒ Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯ Ø¯Ø± ÙˆÛŒØ±Ø§ÛŒØ´
{% if article %}
document.addEventListener('DOMContentLoaded', function() {
    fetch('/api/admin/article-blocks/{{ article.id }}')
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                data.blocks.forEach(block => {
                    addExistingBlock(block);
                });
            }
        });
});

function addExistingBlock(blockData) {
    const template = document.getElementById('blockTemplate');
    const container = document.getElementById('blocksContainer');
    const clone = template.content.cloneNode(true);
    
    // ØªÙ†Ø¸ÛŒÙ… Ù…Ù‚Ø§Ø¯ÛŒØ±
    clone.querySelector('.block-type').value = blockData.block_type;
    clone.querySelector('input[name="order_num[]"]').value = blockData.order_num;
    clone.querySelector('textarea[name="content_fa[]"]').value = blockData.content_fa || '';
    clone.querySelector('textarea[name="content_ku[]"]').value = blockData.content_ku || '';
    clone.querySelector('textarea[name="content_en[]"]').value = blockData.content_en || '';
    
    // ØªÙ†Ø¸ÛŒÙ… block_id Ø¨Ø±Ø§ÛŒ Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§ÛŒ Ù…ÙˆØ¬ÙˆØ¯
    if (blockData.id) {
        clone.querySelector('.block-item').setAttribute('data-block-id', blockData.id);
    }
    
    // ØªÙ†Ø¸ÛŒÙ… Ø±Ù†Ú¯ Ùˆ Ø§Ø³ØªØ§ÛŒÙ„ Ø¨Ø± Ø§Ø³Ø§Ø³ Ù†ÙˆØ¹
    const badge = clone.querySelector('.block-type-badge');
    const blockHeader = clone.querySelector('.block-header');
    
    badge.textContent = getBlockTypeName(blockData.block_type);
    badge.className = 'block-type-badge badge';
    
    switch(blockData.block_type) {
        case 'paragraph':
            badge.classList.add('badge-primary');
            blockHeader.style.background = 'linear-gradient(135deg, #667eea 0%, #764ba2 100%)';
            break;
        case 'subtitle':
            badge.classList.add('badge-secondary');
            blockHeader.style.background = 'linear-gradient(135deg, #6c757d 0%, #495057 100%)';
            break;
        case 'example':
            badge.classList.add('badge-success');
            blockHeader.style.background = 'linear-gradient(135deg, #56ab2f 0%, #a8e6cf 100%)';
            break;
        case 'note':
            badge.classList.add('badge-warning');
            blockHeader.style.background = 'linear-gradient(135deg, #f093fb 0%, #f5576c 100%)';
            break;
        case 'code':
            badge.classList.add('badge-info');
            blockHeader.style.background = 'linear-gradient(135deg, #4facfe 0%, #00f2fe 100%)';
            break;
    }
    
    // ØªÙ†Ø¸ÛŒÙ… metadata
    if (blockData.block_metadata) {
        const metadata = blockData.block_metadata;
        if (metadata.direction) {
            clone.querySelector('.text-direction').value = metadata.direction;
        }
        if (metadata.position) {
            clone.querySelector('.text-position').value = metadata.position;
        }
    }
    
    container.appendChild(clone);
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ ØªØºÛŒÛŒØ± Ù†ÙˆØ¹ Ø¨Ù„Ø§Ú©
    const addedBlock = container.lastElementChild;
    const addedBlockType = addedBlock.querySelector('.block-type');
    addedBlockType.addEventListener('change', function() {
        changeBlockType(this);
    });
    
    blockCounter++;
    updateBlockMetadata();
}
{% endif %}

    // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ metadata Ù‡Ù†Ú¯Ø§Ù… ØªØºÛŒÛŒØ±
    document.addEventListener('change', function(e) {
        if (e.target.matches('.text-direction, .text-position')) {
            updateBlockMetadata();
        }
    });
    
    // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† event listener Ø¨Ø±Ø§ÛŒ form submission
    document.getElementById('articleForm').addEventListener('submit', function(e) {
        console.log('Form submitted!');
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ metadata Ù‚Ø¨Ù„ Ø§Ø² submit
        updateBlockMetadata();
        
        // ØªÙ†Ø¸ÛŒÙ… Ù†ÙˆØ¹ Ø¨Ù„Ø§Ú© Ø§Ø² Ú©Ù¾Ø³Ù„ Ø§Ú¯Ø± Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ Ø¨Ø§Ø´Ø¯
        const blocks = document.querySelectorAll('.block-item');
        blocks.forEach((block, index) => {
            const typeSelect = block.querySelector('.block-type');
            const badge = block.querySelector('.block-type-badge');
            
            // Ø§Ú¯Ø± Ù†ÙˆØ¹ Ø§Ù†ØªØ®Ø§Ø¨ Ù†Ø´Ø¯Ù‡ØŒ Ø§Ø² Ú©Ù¾Ø³Ù„ Ø§Ø³ØªÙØ§Ø¯Ù‡ Ú©Ù†
            if (!typeSelect.value || typeSelect.value === '') {
                const badgeText = badge.textContent.trim();
                let blockType = 'paragraph'; // Ù¾ÛŒØ´â€ŒÙØ±Ø¶
                
                // ØªØ´Ø®ÛŒØµ Ù†ÙˆØ¹ Ø§Ø² Ù…ØªÙ† Ú©Ù¾Ø³Ù„
                if (badgeText.includes('Ù¾Ø§Ø±Ø§Ú¯Ø±Ø§Ù')) blockType = 'paragraph';
                else if (badgeText.includes('ØªÛŒØªØ± ÙØ±Ø¹ÛŒ')) blockType = 'subtitle';
                else if (badgeText.includes('Ù…Ø«Ø§Ù„')) blockType = 'example';
                else if (badgeText.includes('Ù†Ú©ØªÙ‡')) blockType = 'note';
                else if (badgeText.includes('Ú©Ø¯')) blockType = 'code';
                
                typeSelect.value = blockType;
                console.log(`Block ${index}: Set type to '${blockType}' from badge '${badgeText}'`);
            }
        });
        
        // Ù†Ù…Ø§ÛŒØ´ loading
        const submitBtn = this.querySelector('button[type="submit"]');
        const originalText = submitBtn.innerHTML;
        submitBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
        submitBtn.disabled = true;
        
        // ÙØ±Ù… submit Ù…ÛŒâ€ŒØ´ÙˆØ¯
        return true;
    });
    
    // ØªØ§Ø¨Ø¹ Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù„Ø§Ú©
    function saveBlock(button) {
        const blockItem = button.closest('.block-item');
        const saveStatus = blockItem.querySelector('.save-status');
        const originalText = button.innerHTML;
        
        // ØªØºÛŒÛŒØ± Ø¯Ú©Ù…Ù‡ Ø¨Ù‡ Ø­Ø§Ù„Øª loading
        button.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Ø¯Ø± Ø­Ø§Ù„ Ø°Ø®ÛŒØ±Ù‡...';
        button.disabled = true;
        button.classList.remove('btn-success');
        button.classList.add('btn-secondary');
        
        // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù„Ø§Ú©
        const blockData = {
            article_id: {{ article.id if article else 'null' }}, // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† article_id
            block_id: blockItem.dataset.blockId || null, // Ø§Ø¶Ø§ÙÙ‡ Ú©Ø±Ø¯Ù† block_id
            block_type: blockItem.querySelector('.block-type').value,
            content_fa: blockItem.querySelector('textarea[name="content_fa[]"]').value,
            content_ku: blockItem.querySelector('textarea[name="content_ku[]"]').value,
            content_en: blockItem.querySelector('textarea[name="content_en[]"]').value,
            order_num: blockItem.querySelector('input[name="order_num[]"]').value,
            direction: blockItem.querySelector('.text-direction').value,
            position: blockItem.querySelector('.text-position').value
        };
        
        // API call ÙˆØ§Ù‚Ø¹ÛŒ
        fetch('/api/admin/save-block', {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
            },
            body: JSON.stringify(blockData)
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                // Ù…ÙˆÙÙ‚ÛŒØª
                button.innerHTML = '<i class="fas fa-check-circle"></i> Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-success');
                button.disabled = false;
                
                saveStatus.innerHTML = '<span class="text-success"><i class="fas fa-check-circle"></i> Ø¨Ù„Ø§Ú© Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø°Ø®ÛŒØ±Ù‡ Ø´Ø¯</span>';
                saveStatus.className = 'save-status text-success';
                
                // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù„Ø§Ú©
                updateArticleAfterBlockSave();
            } else {
                // Ø®Ø·Ø§
                button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø§';
                button.classList.remove('btn-secondary');
                button.classList.add('btn-danger');
                button.disabled = false;
                
                saveStatus.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> Ø®Ø·Ø§ Ø¯Ø± Ø°Ø®ÛŒØ±Ù‡: ' + data.message + '</span>';
                saveStatus.className = 'save-status text-danger';
            }
            
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                saveStatus.innerHTML = '';
                saveStatus.className = 'save-status';
            }, 3000);
        })
        .catch(error => {
            // Ø®Ø·Ø§ÛŒ Ø´Ø¨Ú©Ù‡
            button.innerHTML = '<i class="fas fa-exclamation-triangle"></i> Ø®Ø·Ø§';
            button.classList.remove('btn-secondary');
            button.classList.add('btn-danger');
            button.disabled = false;
            
            saveStatus.innerHTML = '<span class="text-danger"><i class="fas fa-exclamation-circle"></i> Ø®Ø·Ø§ Ø¯Ø± Ø§ØªØµØ§Ù„</span>';
            saveStatus.className = 'save-status text-danger';
            
            // Ø¨Ø§Ø²Ú¯Ø´Øª Ø¨Ù‡ Ø­Ø§Ù„Øª Ø¹Ø§Ø¯ÛŒ Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => {
                button.innerHTML = originalText;
                button.disabled = false;
                saveStatus.innerHTML = '';
                saveStatus.className = 'save-status';
            }, 3000);
        });
    }
    
    // ØªØ§Ø¨Ø¹ Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø¹Ø¯ Ø§Ø² Ø°Ø®ÛŒØ±Ù‡ Ø¨Ù„Ø§Ú©
    function updateArticleAfterBlockSave() {
        console.log('Updating article after block save...');
        
        // Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ metadata
        updateBlockMetadata();
        
        // Ø¬Ù…Ø¹â€ŒØ¢ÙˆØ±ÛŒ Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ù…Ù‚Ø§Ù„Ù‡
        const articleData = new FormData();
        
        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø§ØµÙ„ÛŒ Ù…Ù‚Ø§Ù„Ù‡
        articleData.append('title_fa', document.getElementById('title_fa').value);
        articleData.append('title_ku', document.getElementById('title_ku').value);
        articleData.append('title_en', document.getElementById('title_en').value);
        articleData.append('excerpt_fa', document.getElementById('excerpt_fa').value);
        articleData.append('excerpt_ku', document.getElementById('excerpt_ku').value);
        articleData.append('excerpt_en', document.getElementById('excerpt_en').value);
        articleData.append('tags_fa', document.getElementById('tags_fa').value);
        articleData.append('tags_ku', document.getElementById('tags_ku').value);
        articleData.append('tags_en', document.getElementById('tags_en').value);
        articleData.append('category', document.getElementById('category').value);
        articleData.append('reading_time', document.getElementById('reading_time').value);
        articleData.append('is_published', document.getElementById('is_published').checked ? 'on' : '');
        
        // Ø§Ø·Ù„Ø§Ø¹Ø§Øª Ø¨Ù„Ø§Ú©â€ŒÙ‡Ø§
        const blocks = document.querySelectorAll('.block-item');
        blocks.forEach((block, index) => {
            const blockType = block.querySelector('.block-type').value;
            const contentFa = block.querySelector('textarea[name="content_fa[]"]').value;
            const contentKu = block.querySelector('textarea[name="content_ku[]"]').value;
            const contentEn = block.querySelector('textarea[name="content_en[]"]').value;
            const orderNum = block.querySelector('input[name="order_num[]"]').value;
            const metadata = block.querySelector('.block-metadata').value;
            
            articleData.append('block_type[]', blockType);
            articleData.append('content_fa[]', contentFa);
            articleData.append('content_ku[]', contentKu);
            articleData.append('content_en[]', contentEn);
            articleData.append('order_num[]', orderNum);
            articleData.append('block_metadata[]', metadata);
        });
        
        // Ø§Ø±Ø³Ø§Ù„ Ø¯Ø±Ø®ÙˆØ§Ø³Øª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ù„Ù‡
        fetch(window.location.href, {
            method: 'POST',
            body: articleData
        })
        .then(response => {
            if (response.redirected) {
                // Ø§Ú¯Ø± redirect Ø´Ø¯ØŒ Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯
                console.log('Article updated successfully, redirecting...');
                window.location.href = response.url;
            } else {
                // Ø¨Ø±Ø±Ø³ÛŒ Ù¾Ø§Ø³Ø®
                return response.text();
            }
        })
        .then(html => {
            if (html) {
                console.log('Article update response received');
                // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ù…ÙˆÙÙ‚ÛŒØª
                const successMessage = document.createElement('div');
                successMessage.className = 'alert alert-success';
                successMessage.innerHTML = '<i class="fas fa-check-circle"></i> Ù…Ù‚Ø§Ù„Ù‡ Ø¨Ø§ Ù…ÙˆÙÙ‚ÛŒØª Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ø´Ø¯';
                successMessage.style.position = 'fixed';
                successMessage.style.top = '20px';
                successMessage.style.right = '20px';
                successMessage.style.zIndex = '9999';
                document.body.appendChild(successMessage);
                
                // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
                setTimeout(() => {
                    successMessage.remove();
                }, 3000);
            }
        })
        .catch(error => {
            console.error('Error updating article:', error);
            // Ù†Ù…Ø§ÛŒØ´ Ù¾ÛŒØ§Ù… Ø®Ø·Ø§
            const errorMessage = document.createElement('div');
            errorMessage.className = 'alert alert-danger';
            errorMessage.innerHTML = '<i class="fas fa-exclamation-circle"></i> Ø®Ø·Ø§ Ø¯Ø± Ø¨Ù‡â€ŒØ±ÙˆØ²Ø±Ø³Ø§Ù†ÛŒ Ù…Ù‚Ø§Ù„Ù‡';
            errorMessage.style.position = 'fixed';
            errorMessage.style.top = '20px';
            errorMessage.style.right = '20px';
            errorMessage.style.zIndex = '9999';
            document.body.appendChild(errorMessage);
            
            // Ø­Ø°Ù Ù¾ÛŒØ§Ù… Ø¨Ø¹Ø¯ Ø§Ø² 3 Ø«Ø§Ù†ÛŒÙ‡
            setTimeout(() => {
                errorMessage.remove();
            }, 3000);
        });
    }
</script>
{% endblock %}
